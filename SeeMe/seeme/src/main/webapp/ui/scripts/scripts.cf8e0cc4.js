"use strict";angular.module("seeMeApp",["ngResource","ngRoute","ngMap"]).config(["$routeProvider",function(a){a.when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/test",{templateUrl:"views/test.html",controller:"TestCtrl"}).when("/:deviceId",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{id:["$q","$route",function(a,b){var c=a.defer(),d=parseInt(b.current.params.deviceId);return isNaN(d)?c.reject("devcieId is not a number"):c.resolve(),c.promise}]}}).otherwise({redirectTo:"/"})}]),angular.module("seeMeApp").service("GpsLogService",["$http","ConfigService",function(a,b){var c=b.baseURL;return{getLatestLog:function(b){return a.get(c+"gpslog/get",{params:{deviceId:b},timeout:2e3})},getLogsSince:function(b,d){return a.get(c+"gpslog/get",{params:{deviceId:b,fromTime:d},timeout:1e4})},getLogsTill:function(b,d){return a.get(c+"gpslog/get",{params:{deviceId:b,toTime:d},timeout:1e4})},getLogsForInterval:function(b,d,e){return a.get(c+"gpslog/get",{params:{deviceId:b,fromTime:d,toTime:e},timeout:1e4})}}}]),angular.module("seeMeApp").controller("MainCtrl",["$scope","$timeout","$routeParams","GpsLogService","ConfigService","User",function(a,b,c,d,e,f){var g=parseInt(c.deviceId);a.user=new f("dl****4@gmail.com","Car","#000088",g);var h=1;a.opacity=e.mapConfig.opacity,a.weight=e.mapConfig.weight;var i=function(){d.getLatestLog(g).success(function(c){a.user.createPathOnMap(a.map),a.user.addNewLog(c[0]),h=1,b(i,1e3*e.refreshInterval)}).error(function(a,c,d,f){h<=1e3*e.maxRetryInterval&&(h=2*h),b(i,h)})};i()}]),angular.module("seeMeApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("seeMeApp").controller("TestCtrl",["$scope","$interval","GpsLogService","User","ConfigService",function(a,b,c,d,e){var f=1434878141e3,g=1434879041e3,h=new d("deepu.bansal@gmail.com","Deepak","#008800",1),i=new d("dl****4@gmail.com","Car","#000088",2);a.users=[h,i];var j=function(c){return function(d){if(d.length>0){var e=0;c.createPathOnMap(a.map),b(function(){var a=d[e++];c.addNewLog(a)},500,d.length)}}};a.opacity=e.mapConfig.opacity,a.weight=e.mapConfig.weight;for(var k=a.users.length-1;k>=0;k--)c.getLogsForInterval(a.users[k].deviceId,f,g).success(j(a.users[k]))}]),angular.module("seeMeApp").service("ConfigService",["UtilityService",function(a){return{baseURL:"../rest/",maxRetryInterval:120,refreshInterval:2,mapConfig:{movingIcon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,scale:4,strokeWeight:2.5,anchor:new google.maps.Point(0,-2),fillOpacity:1,strokeColor:"#000000"},stableIcon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeWeight:2.5,fillOpacity:1,strokeColor:"#000000"},weight:5,opacity:1},movingTimer:5e3}}]),angular.module("seeMeApp").service("UtilityService",function(){return{timeSince:function(a){var b=Math.floor((new Date-a)/1e3),c=Math.floor(b/31536e3);return c>1?c+" years":(c=Math.floor(b/2592e3),c>1?c+" months":(c=Math.floor(b/86400),c>1?c+" days":(c=Math.floor(b/3600),c>1?c+" hours":(c=Math.floor(b/60),c>1?c+" minutes":Math.floor(b)+" seconds"))))},resolveUrl:function(a){var b=document.createElement("a");return b.href=a,a=b.href}}}),angular.module("seeMeApp").directive("standardInterval",["$timeout","UtilityService",function(a,b){return{restrict:"E",link:function(c,d,e){var f,g="",h=1e3;c.$watch(e.since,function(a){f=a,i()});var i=function(){g=b.timeSince(new Date(f)),d.text(g),a(i,h)}}}}]),angular.module("seeMeApp").directive("gpsConsole",function(){return{templateUrl:"views/gpsconsole.html",restrict:"E",link:function(a,b,c){a.$watch(c.gpsInfo,function(b){b&&(b.spd&&(a.speed=Math.round(18*parseFloat(b.spd)/5)),b.timeAsDate&&(a.locationChangedTime=b.timeAsDate))})}}}),angular.module("seeMeApp").directive("userPath",function(){return{restrict:"E",scope:{user:"=userObj",weight:"=",opacity:"="},template:'<shape name="polyline" path="{{user.path.pathCoordinates}}" geodesic="true" stroke-color="{{user.color}}" stroke-opacity="{{opacity}}" stroke-weight="{{weight}}"></shape>'}}),angular.module("seeMeApp").factory("User",["Path",function(a){function b(a,b,c,d){this.username=a,this.name=b,this.color=c,this.path=null,this.deviceId=d,this.lastLog=null}return b.prototype.createPathOnMap=function(b){this.path||(this.path=new a(this.name,this.color,b))},b.prototype.addNewLog=function(a){this.lastLog&&this.lastLog.timeAsDate===a.timeAsDate||(this.lastLog=a,this.path.addNewLog(a))},b}]),angular.module("seeMeApp").factory("Path",["ConfigService","$timeout",function(a,b){function c(b,c,d){this.stableIcon=angular.copy(a.mapConfig.stableIcon),this.stableIcon.fillColor=c,this.movingIcon=angular.copy(a.mapConfig.movingIcon),this.movingIcon.fillColor=c,this.pathCoordinates=null,this.marker=new google.maps.Marker({icon:this.stableIcon,title:b}),this.map=d,this.marker.setMap(this.map),this.lastUpdated=new Date}var d=a.movingTimer,e=null,f=function(a,c){c.movingIcon.rotation=(a+180)%360,c.marker.getIcon()!==c.movingIcon&&c.marker.setIcon(c.movingIcon),e&&b.cancel(e),e=b(function(){g(c)},d)},g=function(a){a.marker.getIcon()!==a.stableIcon&&a.marker.setIcon(a.stableIcon),e&&b.cancel(e)};return c.prototype.addNewLog=function(a){var b=new google.maps.LatLng(parseFloat(a.lat),parseFloat(a.lon));this.marker.setPosition(b);var c=this.map.getBounds();c&&c.contains(b)||this.map.setCenter(b),this.pathCoordinates||(this.pathCoordinates=[]),this.pathCoordinates.push([a.lat,a.lon]);var d=Math.round(parseFloat(a.dir)),e=Math.round(18*parseFloat(a.spd)/5);e>=1?f(d,this):g(this)},c}]),angular.module("seeMeApp").directive("userConsole",function(){return{templateUrl:"views/userconsole.html",restrict:"E",scope:{user:"=userObj"}}});